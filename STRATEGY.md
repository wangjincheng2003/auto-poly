# Polymarket 做市策略详解

## 一、策略概述

**核心思想**：在预测市场中做市，通过挂买单和卖单赚取价差利润。

- **最小利润要求**：0.7%（`MIN_PROFIT = 0.007`）
- **扫描间隔**：10秒
- **最小订单金额**：$5

---

## 二、订单簿分析

### 2.1 排除自己的挂单

在计算市场真实价格前，先从订单簿中剔除自己的挂单：

```python
other_size = float(level.size) - my_sizes.get(price, 0)
```

**目的**：避免把自己的订单当成市场深度，导致价格判断错误。

### 2.2 价格档位选择

使用 `find_price_by_value()` 函数，根据目标金额在订单簿中"穿透"找到合适的价格档：

```
订单簿（买方）:
  0.50 → $100
  0.49 → $200
  0.48 → $150

如果我要挂 $250 的买单：
  累计: 0.50×100=$100 < $250，继续
  累计: 0.50×100 + 0.49×200 = $198 < $250，继续
  累计: $198 + 0.48×150 = $270 >= $250 ✓

结果：买入价 = 0.48
```

**意义**：根据要挂的金额大小，自动选择能被市场"吃掉"的价格深度。

---

## 三、买入逻辑

### 3.1 可用仓位计算

```python
cost_basis = current_size * avg_buy_price      # 已投入成本
available_position = min(max_position - cost_basis, usdc_balance)
```

- 使用**成本基础**而非当前市值计算已用仓位
- 取剩余额度和USDC余额的较小值

### 3.2 买入价格确定

```python
buy_price = find_price_by_value(bid_levels, available_position, is_bid=True)
```

从最高买价开始累计，找到能容纳 `available_position` 金额的价格档。

### 3.3 是否挂买单

```python
target_buy_value = available_position if (best_ask - buy_price) >= 0.007 else 0
```

**条件**：只有当 `最低卖价 - 买入价 ≥ 0.7%` 时才挂买单。

**示例**：
| 最低卖价 | 计算买价 | 价差 | 是否挂单 |
|---------|---------|------|---------|
| 0.55 | 0.50 | 5% | ✅ 挂单 |
| 0.51 | 0.50 | 1% | ✅ 挂单 |
| 0.505 | 0.50 | 0.5% | ❌ 不挂 |

### 3.4 买单拆分

```python
max_order_value = 10.0  # 每个买单最大$10
while shortage >= MIN_ORDER_VALUE:
    order_value = min(shortage, max_order_value)
    # 创建订单...
```

**原因**：拆分成小单，降低单笔成交风险，更灵活地被部分成交。

---

## 四、卖出逻辑

### 4.1 保本价计算

```python
target_profit_price = min(avg_buy_price + 0.007, 0.999)
```

卖出价至少要比买入均价高 **0.7%**。

### 4.2 卖出价格确定

```python
sell_price = max(
    find_price_by_value(ask_levels, current_size * best_ask, is_bid=False),
    target_profit_price
)
```

取以下两者的**较大值**：
1. 根据持仓量在卖方订单簿中找到的价格档
2. 保本价（买入均价 + 0.7%）

### 4.3 卖单金额

```python
target_sell_value = current_size * sell_price  # 卖出全部持仓
```

---

## 五、订单管理

### 5.1 智能调整流程

```
┌────────────────────────────────────────────────────────┐
│                    manage_orders_smart                  │
├────────────────────────────────────────────────────────┤
│  1. 取消价格不对的订单                                   │
│     if order.price != target_price → cancel            │
├────────────────────────────────────────────────────────┤
│  2. 计算价格正确的订单总值                               │
│     current_value = Σ(remaining_size × price)          │
├────────────────────────────────────────────────────────┤
│  3. 金额过多 → 取消多余订单（按时间倒序，先取消最新的）    │
│     while current_value > target_value:                │
│         cancel(newest_order)                           │
├────────────────────────────────────────────────────────┤
│  4. 金额不足 → 补充新订单                               │
│     if shortage >= $5:                                 │
│         create_order(shortage)                         │
└────────────────────────────────────────────────────────┘
```

### 5.2 订单类型差异

| 类型 | 拆分策略 | 原因 |
|-----|---------|------|
| 买单 | 拆成多个 ≤$10 的小单 | 分散风险，灵活成交 |
| 卖单 | 单个大订单 | 简化管理，一次性出货 |

---

## 六、仓位与风控

### 6.1 仓位限制

每个市场在 `markets_config.json` 中配置 `max_position_value`：

```json
{
  "name": "Will China invade Taiwan?",
  "max_position_value": 30.0,  // 最多投入$30
  ...
}
```

### 6.2 成交通知

持仓变化超过 0.01 时，发送微信通知：

```
🟢 买入成交 - Will China invade Taiwan?
市场: Will China invade Taiwan?
数量变化: +10.50
当前持仓: 10.50 ($5.25)
```

### 6.3 异常处理

- **网络异常**：自动重置 HTTP Session
- **连续失败50次**：发送微信告警
- **单次失败**：等待10秒后继续

---

## 七、完整流程图

```
每10秒执行一次
      │
      ▼
┌─────────────────┐
│ 加载市场配置     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 并发处理所有市场 │ ◄── ThreadPoolExecutor
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌───────┐
│市场1  │ │市场2  │ ...
└───┬───┘ └───┬───┘
    │         │
    ▼         ▼
┌─────────────────────────────────────┐
│ process_market():                   │
│  1. 获取订单簿，排除自己的挂单        │
│  2. 获取当前持仓和买入均价           │
│  3. 计算可用仓位                     │
│  4. 确定买入价，检查价差是否足够      │
│  5. 确定卖出价，确保高于保本价        │
│  6. 管理买单（取消/补充）            │
│  7. 管理卖单（取消/补充）            │
│  8. 检测成交，发送通知               │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 输出状态信息     │
└────────┬────────┘
         │
         ▼
    等待10秒...
```

---

## 八、关键参数汇总

| 参数 | 值 | 位置 | 说明 |
|------|-----|------|------|
| `MIN_PROFIT` | 0.007 | trade.py | 最小利润空间 (0.7%) |
| `MIN_ORDER_VALUE` | 5.0 | trade.py | 最小订单金额 ($5) |
| `SCAN_INTERVAL` | 10 | trade.py | 扫描间隔 (秒) |
| `max_order_value` | 10.0 | trade.py | 单个买单最大金额 |
| `max_position_value` | 各市场配置 | markets_config.json | 单市场最大仓位 |
